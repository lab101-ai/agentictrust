<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgenticTrust Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">AgenticTrust</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="/api/admin/dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#agents">Agents</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#tools">Tools</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#tokens">Tokens</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#audit">Audit Logs</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h1>Admin Dashboard</h1>
        
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-number" id="agents-count">{{ agents_count }}</div>
                    <div class="stats-label">Registered Agents</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-number" id="tools-count">{{ tools_count }}</div>
                    <div class="stats-label">Registered Tools</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-number" id="tokens-count">{{ tokens_count }}</div>
                    <div class="stats-label">Total Tokens</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-number" id="active-tokens-count">{{ active_tokens_count }}</div>
                    <div class="stats-label">Active Tokens</div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 id="agents" class="mb-0">Agents</h5>
                        <button class="btn btn-primary btn-sm" id="register-agent-btn" data-bs-toggle="modal" data-bs-target="#registerAgentModal">Register New Agent</button>
                    </div>
                    <div class="card-body">
                        {% if agents %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Client ID</th>
                                        <th>Agent Name</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="agents-table">
                                    {% for agent in agents %}
                                    <tr>
                                        <td>{{ agent.client_id }}</td>
                                        <td>{{ agent.agent_name }}</td>
                                        <td><span class="badge {% if agent.is_active %}bg-success{% else %}bg-secondary{% endif %}">{{ "Active" if agent.is_active else "Inactive" }}</span></td>
                                        <td>{{ agent.created_at }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-info view-agent" data-id="{{ agent.client_id }}" data-bs-toggle="modal" data-bs-target="#viewAgentModal">View</button>
                                            <button class="btn btn-sm btn-warning manage-agent-tools" data-id="{{ agent.client_id }}" data-bs-toggle="modal" data-bs-target="#manageAgentToolsModal">Tools</button>
                                            <button class="btn btn-sm btn-danger delete-agent" data-id="{{ agent.client_id }}">Delete</button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-info">No agents registered yet. Click "Register New Agent" to create one.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 id="tools" class="mb-0">Tools</h5>
                        <button class="btn btn-primary btn-sm" id="register-tool-btn" data-bs-toggle="modal" data-bs-target="#registerToolModal">Register New Tool</button>
                    </div>
                    <div class="card-body">
                        {% if tools %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Tool ID</th>
                                        <th>Name</th>
                                        <th>Category</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tools-table">
                                    {% for tool in tools %}
                                    <tr>
                                        <td>{{ tool.tool_id }}</td>
                                        <td>{{ tool.name }}</td>
                                        <td>{{ tool.category or 'N/A' }}</td>
                                        <td><span class="badge {% if tool.is_active %}bg-success{% else %}bg-secondary{% endif %}">{{ "Active" if tool.is_active else "Inactive" }}</span></td>
                                        <td>
                                            <button class="btn btn-sm btn-info view-tool" data-id="{{ tool.tool_id }}" data-bs-toggle="modal" data-bs-target="#viewToolModal">View</button>
                                            <button class="btn btn-sm btn-warning edit-tool" data-id="{{ tool.tool_id }}" data-bs-toggle="modal" data-bs-target="#editToolModal">Edit</button>
                                            <button class="btn btn-sm btn-danger delete-tool" data-id="{{ tool.tool_id }}">Delete</button>
                                            {% if tool.is_active %}
                                            <button class="btn btn-sm btn-secondary deactivate-tool" data-id="{{ tool.tool_id }}">Deactivate</button>
                                            {% else %}
                                            <button class="btn btn-sm btn-success activate-tool" data-id="{{ tool.tool_id }}">Activate</button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-info">No tools registered yet. Click "Register New Tool" to create one.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 id="tokens" class="mb-0">Active Tokens</h5>
                    </div>
                    <div class="card-body">
                        {% if tokens %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Token ID</th>
                                        <th>Client ID</th>
                                        <th>Task ID</th>
                                        <th>Issued At</th>
                                        <th>Expires At</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tokens-table">
                                    {% for token in tokens %}
                                    <tr>
                                        <td>{{ token.token_id }}</td>
                                        <td>{{ token.client_id }}</td>
                                        <td>{{ token.task_id }}</td>
                                        <td>{{ token.issued_at }}</td>
                                        <td>{{ token.expires_at }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-info view-token" data-id="{{ token.token_id }}" data-bs-toggle="modal" data-bs-target="#viewTokenModal">View</button>
                                            <button class="btn btn-sm btn-warning revoke-token" data-id="{{ token.token_id }}">Revoke</button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-info">No active tokens available.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4 mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 id="audit" class="mb-0">Recent Audit Logs</h5>
                        <a href="/api/admin/audit/logs" class="btn btn-primary btn-sm">View All Logs</a>
                    </div>
                    <div class="card-body">
                        {% if logs %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Client ID</th>
                                        <th>Task ID</th>
                                        <th>Event Type</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="logs-table">
                                    {% for log in logs %}
                                    <tr>
                                        <td>{{ log.timestamp }}</td>
                                        <td>{{ log.client_id }}</td>
                                        <td>{{ log.task_id }}</td>
                                        <td>{{ log.event_type }}</td>
                                        <td><span class="badge {% if log.status == 'success' %}bg-success{% elif log.status == 'failed' %}bg-danger{% else %}bg-secondary{% endif %}">{{ log.status }}</span></td>
                                        <td>
                                            <button class="btn btn-sm btn-info view-log" data-id="{{ log.log_id }}" data-bs-toggle="modal" data-bs-target="#viewLogModal">Details</button>
                                            <button class="btn btn-sm btn-secondary view-task-chain" data-task-id="{{ log.task_id }}">Chain</button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-info">No audit logs available yet.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <!-- View Agent Modal -->
    <div class="modal fade" id="viewAgentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Agent Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="agent-details">
                    Loading...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- View Token Modal -->
    <div class="modal fade" id="viewTokenModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Token Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="token-details">
                    Loading...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- View Log Modal -->
    <div class="modal fade" id="viewLogModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Log Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="log-details">
                    Loading...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Register Agent Modal -->
    <div class="modal fade" id="registerAgentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Register New Agent</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="register-agent-form">
                        <div class="mb-3">
                            <label for="agent-name" class="form-label">Agent Name</label>
                            <input type="text" class="form-control" id="agent-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="agent-description" class="form-label">Description</label>
                            <textarea class="form-control" id="agent-description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Allowed Tools</label>
                            <div id="agent-tools-checkboxes">
                                <div class="alert alert-info">Loading available tools...</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Allowed Resources</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="github" id="resource-github">
                                <label class="form-check-label" for="resource-github">github</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="jira" id="resource-jira">
                                <label class="form-check-label" for="resource-jira">jira</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="s3" id="resource-s3">
                                <label class="form-check-label" for="resource-s3">s3</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="max-scope-level" class="form-label">Maximum Scope Level</label>
                            <select class="form-select" id="max-scope-level">
                                <option value="restricted">Restricted</option>
                                <option value="standard">Standard</option>
                                <option value="elevated">Elevated</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submit-register-agent">Register</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Register Tool Modal -->
    <div class="modal fade" id="registerToolModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Register New Tool</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="register-tool-form">
                        <div class="mb-3">
                            <label for="tool-name" class="form-label">Tool Name</label>
                            <input type="text" class="form-control" id="tool-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="tool-description" class="form-label">Description</label>
                            <textarea class="form-control" id="tool-description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="tool-category" class="form-label">Category</label>
                            <select class="form-select" id="tool-category">
                                <option value="">-- Select Category --</option>
                                <option value="file">File Operations</option>
                                <option value="database">Database Operations</option>
                                <option value="api">API Calls</option>
                                <option value="utility">Utility</option>
                                <option value="ai">AI/ML</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Permissions Required</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="read" id="perm-read">
                                <label class="form-check-label" for="perm-read">read</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="write" id="perm-write">
                                <label class="form-check-label" for="perm-write">write</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="execute" id="perm-execute">
                                <label class="form-check-label" for="perm-execute">execute</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submit-register-tool">Register</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- View Tool Modal -->
    <div class="modal fade" id="viewToolModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tool Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="tool-details">
                    Loading...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Tool Modal -->
    <div class="modal fade" id="editToolModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Tool</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-tool-form">
                        <input type="hidden" id="edit-tool-id">
                        <div class="mb-3">
                            <label for="edit-tool-name" class="form-label">Tool Name</label>
                            <input type="text" class="form-control" id="edit-tool-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-tool-description" class="form-label">Description</label>
                            <textarea class="form-control" id="edit-tool-description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="edit-tool-category" class="form-label">Category</label>
                            <select class="form-select" id="edit-tool-category">
                                <option value="">-- Select Category --</option>
                                <option value="file">File Operations</option>
                                <option value="database">Database Operations</option>
                                <option value="api">API Calls</option>
                                <option value="utility">Utility</option>
                                <option value="ai">AI/ML</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Permissions Required</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="read" id="edit-perm-read">
                                <label class="form-check-label" for="edit-perm-read">read</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="write" id="edit-perm-write">
                                <label class="form-check-label" for="edit-perm-write">write</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="execute" id="edit-perm-execute">
                                <label class="form-check-label" for="edit-perm-execute">execute</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submit-edit-tool">Update</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Manage Agent Tools Modal -->
    <div class="modal fade" id="manageAgentToolsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Manage Agent Tools</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="manage-agent-id">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Agent Information</h6>
                            <div id="manage-agent-info">Loading...</div>
                        </div>
                        <div class="col-md-6">
                            <h6>Available Tools</h6>
                            <div id="available-tools-list" class="list-group">
                                Loading available tools...
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div>
                        <h6>Current Agent Tools</h6>
                        <div id="agent-tools-list" class="list-group">
                            Loading agent's tools...
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Token revocation
            document.querySelectorAll('.revoke-token').forEach(button => {
                button.addEventListener('click', function() {
                    const tokenId = this.getAttribute('data-id');
                    if (confirm('Are you sure you want to revoke this token? This will also revoke all child tokens.')) {
                        fetch(`/api/admin/tokens/${tokenId}/revoke`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ reason: 'Admin revocation via dashboard' })
                        })
                        .then(response => response.json())
                        .then(data => {
                            alert('Token revoked successfully');
                            window.location.reload();
                        })
                        .catch(error => {
                            alert('Error revoking token');
                            console.error('Error:', error);
                        });
                    }
                });
            });
            
            // Agent deletion
            document.querySelectorAll('.delete-agent').forEach(button => {
                button.addEventListener('click', function() {
                    const clientId = this.getAttribute('data-id');
                    if (confirm('Are you sure you want to delete this agent? This will also delete all related tokens and logs.')) {
                        fetch(`/api/agents/${clientId}`, {
                            method: 'DELETE'
                        })
                        .then(response => response.json())
                        .then(data => {
                            alert('Agent deleted successfully');
                            window.location.reload();
                        })
                        .catch(error => {
                            alert('Error deleting agent');
                            console.error('Error:', error);
                        });
                    }
                });
            });
            
            // View agent details
            document.querySelectorAll('.view-agent').forEach(button => {
                button.addEventListener('click', function() {
                    const clientId = this.getAttribute('data-id');
                    const detailsContainer = document.getElementById('agent-details');
                    detailsContainer.innerHTML = 'Loading...';
                    
                    fetch(`/api/agents/${clientId}`)
                        .then(response => response.json())
                        .then(data => {
                            let html = `
                                <dl class="row">
                                    <dt class="col-sm-4">Client ID</dt>
                                    <dd class="col-sm-8">${data.client_id}</dd>
                                    
                                    <dt class="col-sm-4">Agent Name</dt>
                                    <dd class="col-sm-8">${data.agent_name}</dd>
                                    
                                    <dt class="col-sm-4">Description</dt>
                                    <dd class="col-sm-8">${data.description || 'N/A'}</dd>
                                    
                                    <dt class="col-sm-4">Status</dt>
                                    <dd class="col-sm-8">${data.is_active ? 'Active' : 'Inactive'}</dd>
                                    
                                    <dt class="col-sm-4">Created</dt>
                                    <dd class="col-sm-8">${data.created_at}</dd>
                                    
                                    <dt class="col-sm-4">Updated</dt>
                                    <dd class="col-sm-8">${data.updated_at}</dd>
                                    
                                    <dt class="col-sm-4">Allowed Resources</dt>
                                    <dd class="col-sm-8">${data.allowed_resources.join(', ') || 'None'}</dd>
                                    
                                    <dt class="col-sm-4">Max Scope Level</dt>
                                    <dd class="col-sm-8">${data.max_scope_level}</dd>
                                </dl>
                            `;
                            
                            // Display associated tools
                            html += `<h6 class="mt-3">Assigned Tools:</h6>`;
                            if (data.tools && data.tools.length > 0) {
                                html += `<ul class="list-group">`;
                                data.tools.forEach(tool => {
                                    html += `
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            ${tool.name}
                                            <span class="badge ${tool.is_active ? 'bg-success' : 'bg-secondary'} ms-2">
                                                ${tool.category || 'No category'}
                                            </span>
                                        </li>
                                    `;
                                });
                                html += `</ul>`;
                            } else {
                                html += `<p>No tools assigned to this agent.</p>`;
                            }
                            
                            detailsContainer.innerHTML = html;
                        })
                        .catch(error => {
                            detailsContainer.innerHTML = `<div class="alert alert-danger">Error loading agent details</div>`;
                            console.error('Error:', error);
                        });
                });
            });
            
            // View token details
            document.querySelectorAll('.view-token').forEach(button => {
                button.addEventListener('click', function() {
                    const tokenId = this.getAttribute('data-id');
                    const detailsContainer = document.getElementById('token-details');
                    detailsContainer.innerHTML = 'Loading...';
                    
                    fetch(`/api/admin/tokens/${tokenId}?include_children=true`)
                        .then(response => response.json())
                        .then(data => {
                            let html = `
                                <dl class="row">
                                    <dt class="col-sm-4">Token ID</dt>
                                    <dd class="col-sm-8">${data.token_id}</dd>
                                    
                                    <dt class="col-sm-4">Client ID</dt>
                                    <dd class="col-sm-8">${data.client_id}</dd>
                                    
                                    <dt class="col-sm-4">Task ID</dt>
                                    <dd class="col-sm-8">${data.task_id}</dd>
                                    
                                    <dt class="col-sm-4">Parent Task ID</dt>
                                    <dd class="col-sm-8">${data.parent_task_id || 'N/A'}</dd>
                                    
                                    <dt class="col-sm-4">Parent Token ID</dt>
                                    <dd class="col-sm-8">${data.parent_token_id || 'N/A'}</dd>
                                    
                                    <dt class="col-sm-4">Task Description</dt>
                                    <dd class="col-sm-8">${data.task_description || 'N/A'}</dd>
                                    
                                    <dt class="col-sm-4">Scope</dt>
                                    <dd class="col-sm-8">${data.scope.join(', ') || 'None'}</dd>
                                    
                                    <dt class="col-sm-4">Granted Tools</dt>
                                    <dd class="col-sm-8">${data.granted_tools.join(', ') || 'None'}</dd>
                                    
                                    <dt class="col-sm-4">Granted Resources</dt>
                                    <dd class="col-sm-8">${data.granted_resources.join(', ') || 'None'}</dd>
                                    
                                    <dt class="col-sm-4">Issued At</dt>
                                    <dd class="col-sm-8">${data.issued_at}</dd>
                                    
                                    <dt class="col-sm-4">Expires At</dt>
                                    <dd class="col-sm-8">${data.expires_at}</dd>
                                    
                                    <dt class="col-sm-4">Is Revoked</dt>
                                    <dd class="col-sm-8">${data.is_revoked ? 'Yes' : 'No'}</dd>
                                    
                                    <dt class="col-sm-4">Is Valid</dt>
                                    <dd class="col-sm-8">${data.is_valid ? 'Yes' : 'No'}</dd>
                                </dl>
                            `;
                            
                            if (data.child_tokens && data.child_tokens.length > 0) {
                                html += `
                                    <h6 class="mt-3">Child Tokens:</h6>
                                    <ul class="list-group">
                                `;
                                data.child_tokens.forEach(child => {
                                    html += `<li class="list-group-item">${child.token_id} (Task: ${child.task_id})</li>`;
                                });
                                html += `</ul>`;
                            }
                            
                            detailsContainer.innerHTML = html;
                        })
                        .catch(error => {
                            detailsContainer.innerHTML = `<div class="alert alert-danger">Error loading token details</div>`;
                            console.error('Error:', error);
                        });
                });
            });
            
            // Load available tools for the agent registration modal
            document.getElementById('register-agent-btn')?.addEventListener('click', function() {
                // Fetch all available tools
                fetch('/api/tools?is_active=true')
                    .then(response => response.json())
                    .then(data => {
                        const container = document.getElementById('agent-tools-checkboxes');
                        const tools = data.tools || [];
                        
                        if (tools.length === 0) {
                            container.innerHTML = '<div class="alert alert-warning">No active tools available. Please create tools first.</div>';
                            return;
                        }
                        
                        let html = '';
                        tools.forEach(tool => {
                            html += `
                                <div class="form-check">
                                    <input class="form-check-input agent-tool-checkbox" type="checkbox" 
                                           value="${tool.tool_id}" id="tool-${tool.tool_id}">
                                    <label class="form-check-label" for="tool-${tool.tool_id}">
                                        ${tool.name} ${tool.category ? `(${tool.category})` : ''}
                                    </label>
                                </div>
                            `;
                        });
                        
                        container.innerHTML = html;
                    })
                    .catch(error => {
                        console.error('Error loading tools:', error);
                        document.getElementById('agent-tools-checkboxes').innerHTML = 
                            '<div class="alert alert-danger">Error loading tools. Please try again.</div>';
                    });
            });
            
            // Register new agent
            document.getElementById('submit-register-agent')?.addEventListener('click', function() {
                const agentName = document.getElementById('agent-name').value;
                if (!agentName) {
                    alert('Agent name is required');
                    return;
                }
                
                const description = document.getElementById('agent-description').value;
                const maxScopeLevel = document.getElementById('max-scope-level').value;
                
                // Get selected tool IDs
                const selectedToolIds = [];
                document.querySelectorAll('.agent-tool-checkbox:checked').forEach(checkbox => {
                    selectedToolIds.push(checkbox.value);
                });
                
                // Get selected resources
                const allowedResources = [];
                document.querySelectorAll('input[id^="resource-"]:checked').forEach(checkbox => {
                    allowedResources.push(checkbox.value);
                });
                
                // Submit registration
                fetch('/api/agents/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        agent_name: agentName,
                        description: description,
                        allowed_resources: allowedResources,
                        max_scope_level: maxScopeLevel,
                        tool_ids: selectedToolIds
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`Error: ${data.error}`);
                        return;
                    }
                    
                    // Show success message with credentials
                    alert(`Agent registered successfully!\n\nClient ID: ${data.credentials.client_id}\nClient Secret: ${data.credentials.client_secret}\n\nPlease save these credentials securely. The client secret will not be shown again.`);
                    
                    // Activate the agent automatically
                    return fetch('/api/agents/activate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            registration_token: data.credentials.registration_token
                        })
                    });
                })
                .then(response => {
                    if (response) {
                        return response.json();
                    }
                })
                .then(data => {
                    if (data && data.message) {
                        console.log(data.message);
                    }
                    // Reload the page to show the new agent
                    window.location.reload();
                })
                .catch(error => {
                    alert('Error registering agent');
                    console.error('Error:', error);
                });
            });
            
            // View log details
            document.querySelectorAll('.view-log').forEach(button => {
                button.addEventListener('click', function() {
                    const logId = this.getAttribute('data-id');
                    const taskId = this.closest('tr').querySelector('td:nth-child(3)').textContent;
                    const detailsContainer = document.getElementById('log-details');
                    detailsContainer.innerHTML = 'Loading...';
                    
                    // Get task history
                    fetch(`/api/admin/audit/task/${taskId}`)
                        .then(response => response.json())
                        .then(data => {
                            // Find the specific log
                            const log = data.history.find(log => log.log_id === logId);
                            
                            if (!log) {
                                detailsContainer.innerHTML = `<div class="alert alert-danger">Log not found</div>`;
                                return;
                            }
                            
                            let html = `
                                <dl class="row">
                                    <dt class="col-sm-4">Log ID</dt>
                                    <dd class="col-sm-8">${log.log_id}</dd>
                                    
                                    <dt class="col-sm-4">Client ID</dt>
                                    <dd class="col-sm-8">${log.client_id}</dd>
                                    
                                    <dt class="col-sm-4">Token ID</dt>
                                    <dd class="col-sm-8">${log.token_id}</dd>
                                    
                                    <dt class="col-sm-4">Task ID</dt>
                                    <dd class="col-sm-8">${log.task_id}</dd>
                                    
                                    <dt class="col-sm-4">Parent Task ID</dt>
                                    <dd class="col-sm-8">${log.parent_task_id || 'N/A'}</dd>
                                    
                                    <dt class="col-sm-4">Event Type</dt>
                                    <dd class="col-sm-8">${log.event_type}</dd>
                                    
                                    <dt class="col-sm-4">Timestamp</dt>
                                    <dd class="col-sm-8">${log.timestamp}</dd>
                                    
                                    <dt class="col-sm-4">Status</dt>
                                    <dd class="col-sm-8">${log.status}</dd>
                                    
                                    <dt class="col-sm-4">Source IP</dt>
                                    <dd class="col-sm-8">${log.source_ip || 'N/A'}</dd>
                                </dl>
                            `;
                            
                            if (log.details && Object.keys(log.details).length > 0) {
                                html += `
                                    <h6 class="mt-3">Details:</h6>
                                    <pre class="bg-light p-2 rounded"><code>${JSON.stringify(log.details, null, 2)}</code></pre>
                                `;
                            }
                            
                            detailsContainer.innerHTML = html;
                        })
                        .catch(error => {
                            detailsContainer.innerHTML = `<div class="alert alert-danger">Error loading log details</div>`;
                            console.error('Error:', error);
                        });
                });
            });
            
            // View task chain
            document.querySelectorAll('.view-task-chain').forEach(button => {
                button.addEventListener('click', function() {
                    const taskId = this.getAttribute('data-task-id');
                    window.location.href = `/api/admin/audit/task-chain/${taskId}`;
                });
            });
            
            // Tool Registration
            document.getElementById('submit-register-tool')?.addEventListener('click', function() {
                const name = document.getElementById('tool-name').value;
                if (!name) {
                    alert('Tool name is required');
                    return;
                }
                
                const description = document.getElementById('tool-description').value;
                const category = document.getElementById('tool-category').value;
                
                // Get selected permissions
                const permissionsRequired = [];
                document.querySelectorAll('input[id^="perm-"]:checked').forEach(checkbox => {
                    permissionsRequired.push(checkbox.value);
                });
                
                // Submit registration
                fetch('/api/tools', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        category: category,
                        permissions_required: permissionsRequired,
                        parameters: []
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`Error: ${data.error}`);
                        return;
                    }
                    
                    alert('Tool registered successfully!');
                    window.location.reload();
                })
                .catch(error => {
                    alert('Error registering tool');
                    console.error('Error:', error);
                });
            });
            
            // View tool details
            document.querySelectorAll('.view-tool').forEach(button => {
                button.addEventListener('click', function() {
                    const toolId = this.getAttribute('data-id');
                    const detailsContainer = document.getElementById('tool-details');
                    detailsContainer.innerHTML = 'Loading...';
                    
                    fetch(`/api/tools/${toolId}`)
                        .then(response => response.json())
                        .then(data => {
                            let html = `
                                <dl class="row">
                                    <dt class="col-sm-4">Tool ID</dt>
                                    <dd class="col-sm-8">${data.tool_id}</dd>
                                    
                                    <dt class="col-sm-4">Name</dt>
                                    <dd class="col-sm-8">${data.name}</dd>
                                    
                                    <dt class="col-sm-4">Description</dt>
                                    <dd class="col-sm-8">${data.description || 'N/A'}</dd>
                                    
                                    <dt class="col-sm-4">Category</dt>
                                    <dd class="col-sm-8">${data.category || 'N/A'}</dd>
                                    
                                    <dt class="col-sm-4">Status</dt>
                                    <dd class="col-sm-8">${data.is_active ? 'Active' : 'Inactive'}</dd>
                                    
                                    <dt class="col-sm-4">Permissions Required</dt>
                                    <dd class="col-sm-8">${data.permissions_required.join(', ') || 'None'}</dd>
                                    
                                    <dt class="col-sm-4">Created At</dt>
                                    <dd class="col-sm-8">${data.created_at}</dd>
                                    
                                    <dt class="col-sm-4">Updated At</dt>
                                    <dd class="col-sm-8">${data.updated_at}</dd>
                                </dl>
                            `;
                            
                            detailsContainer.innerHTML = html;
                        })
                        .catch(error => {
                            detailsContainer.innerHTML = `<div class="alert alert-danger">Error loading tool details</div>`;
                            console.error('Error:', error);
                        });
                });
            });
            
            // Load tool data for editing
            document.querySelectorAll('.edit-tool').forEach(button => {
                button.addEventListener('click', function() {
                    const toolId = this.getAttribute('data-id');
                    
                    fetch(`/api/tools/${toolId}`)
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('edit-tool-id').value = data.tool_id;
                            document.getElementById('edit-tool-name').value = data.name;
                            document.getElementById('edit-tool-description').value = data.description || '';
                            document.getElementById('edit-tool-category').value = data.category || '';
                            
                            // Set permissions checkboxes
                            document.getElementById('edit-perm-read').checked = data.permissions_required.includes('read');
                            document.getElementById('edit-perm-write').checked = data.permissions_required.includes('write');
                            document.getElementById('edit-perm-execute').checked = data.permissions_required.includes('execute');
                        })
                        .catch(error => {
                            alert('Error loading tool data');
                            console.error('Error:', error);
                        });
                });
            });
            
            // Update tool
            document.getElementById('submit-edit-tool')?.addEventListener('click', function() {
                const toolId = document.getElementById('edit-tool-id').value;
                const name = document.getElementById('edit-tool-name').value;
                
                if (!name) {
                    alert('Tool name is required');
                    return;
                }
                
                const description = document.getElementById('edit-tool-description').value;
                const category = document.getElementById('edit-tool-category').value;
                
                // Get selected permissions
                const permissionsRequired = [];
                document.querySelectorAll('input[id^="edit-perm-"]:checked').forEach(checkbox => {
                    permissionsRequired.push(checkbox.value.replace('edit-perm-', ''));
                });
                
                // Submit update
                fetch(`/api/tools/${toolId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        category: category,
                        permissions_required: permissionsRequired
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`Error: ${data.error}`);
                        return;
                    }
                    
                    alert('Tool updated successfully!');
                    window.location.reload();
                })
                .catch(error => {
                    alert('Error updating tool');
                    console.error('Error:', error);
                });
            });
            
            // Delete tool
            document.querySelectorAll('.delete-tool').forEach(button => {
                button.addEventListener('click', function() {
                    const toolId = this.getAttribute('data-id');
                    
                    if (confirm('Are you sure you want to delete this tool?')) {
                        fetch(`/api/tools/${toolId}`, {
                            method: 'DELETE'
                        })
                        .then(response => response.json())
                        .then(data => {
                            alert('Tool deleted successfully');
                            window.location.reload();
                        })
                        .catch(error => {
                            alert('Error deleting tool');
                            console.error('Error:', error);
                        });
                    }
                });
            });
            
            // Activate tool
            document.querySelectorAll('.activate-tool').forEach(button => {
                button.addEventListener('click', function() {
                    const toolId = this.getAttribute('data-id');
                    
                    fetch(`/api/tools/${toolId}/activate`, {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        alert('Tool activated successfully');
                        window.location.reload();
                    })
                    .catch(error => {
                        alert('Error activating tool');
                        console.error('Error:', error);
                    });
                });
            });
            
            // Deactivate tool
            document.querySelectorAll('.deactivate-tool').forEach(button => {
                button.addEventListener('click', function() {
                    const toolId = this.getAttribute('data-id');
                    
                    fetch(`/api/tools/${toolId}/deactivate`, {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        alert('Tool deactivated successfully');
                        window.location.reload();
                    })
                    .catch(error => {
                        alert('Error deactivating tool');
                        console.error('Error:', error);
                    });
                });
            });
            
            // Manage agent tools
            document.querySelectorAll('.manage-agent-tools').forEach(button => {
                button.addEventListener('click', function() {
                    const agentId = this.getAttribute('data-id');
                    document.getElementById('manage-agent-id').value = agentId;
                    
                    // Load agent info
                    fetch(`/api/agents/${agentId}`)
                        .then(response => response.json())
                        .then(agent => {
                            document.getElementById('manage-agent-info').innerHTML = `
                                <p><strong>Agent Name:</strong> ${agent.agent_name}</p>
                                <p><strong>Description:</strong> ${agent.description || 'N/A'}</p>
                                <p><strong>Status:</strong> ${agent.is_active ? 'Active' : 'Inactive'}</p>
                            `;
                            
                            // Load agent's current tools
                            return fetch(`/api/agents/${agentId}/tools`);
                        })
                        .then(response => response.json())
                        .then(data => {
                            const agentTools = data.tools;
                            const agentToolIds = agentTools.map(tool => tool.tool_id);
                            
                            // Render agent's tools
                            let agentToolsHtml = '';
                            if (agentTools.length === 0) {
                                agentToolsHtml = '<div class="alert alert-info">Agent has no tools assigned yet.</div>';
                            } else {
                                agentToolsHtml = '<div class="list-group">';
                                agentTools.forEach(tool => {
                                    agentToolsHtml += `
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>${tool.name}</strong>
                                                <span class="badge ${tool.is_active ? 'bg-success' : 'bg-secondary'} ms-2">${tool.is_active ? 'Active' : 'Inactive'}</span>
                                                <br>
                                                <small>${tool.category || 'N/A'}</small>
                                            </div>
                                            <button class="btn btn-sm btn-danger remove-tool" data-agent-id="${agentId}" data-tool-id="${tool.tool_id}">Remove</button>
                                        </div>
                                    `;
                                });
                                agentToolsHtml += '</div>';
                            }
                            document.getElementById('agent-tools-list').innerHTML = agentToolsHtml;
                            
                            // Set up removal buttons
                            document.querySelectorAll('.remove-tool').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const thisAgentId = this.getAttribute('data-agent-id');
                                    const toolId = this.getAttribute('data-tool-id');
                                    
                                    fetch(`/api/agents/${thisAgentId}/tools/${toolId}`, {
                                        method: 'DELETE'
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        alert('Tool removed from agent successfully');
                                        // Reload the modal content
                                        const modalButton = document.querySelector(`.manage-agent-tools[data-id="${thisAgentId}"]`);
                                        modalButton.click();
                                    })
                                    .catch(error => {
                                        alert('Error removing tool from agent');
                                        console.error('Error:', error);
                                    });
                                });
                            });
                            
                            // Load all available tools
                            return fetch('/api/tools');
                        })
                        .then(response => response.json())
                        .then(data => {
                            const allTools = data.tools;
                            const agentToolIds = document.querySelectorAll('.remove-tool')
                                .map(btn => btn.getAttribute('data-tool-id'));
                            
                            // Filter to show only tools not already assigned to the agent
                            const availableTools = allTools.filter(tool => !agentToolIds.includes(tool.tool_id));
                            
                            // Render available tools
                            let availableToolsHtml = '';
                            if (availableTools.length === 0) {
                                availableToolsHtml = '<div class="alert alert-info">No additional tools available.</div>';
                            } else {
                                availableToolsHtml = '<div class="list-group">';
                                availableTools.forEach(tool => {
                                    availableToolsHtml += `
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>${tool.name}</strong>
                                                <span class="badge ${tool.is_active ? 'bg-success' : 'bg-secondary'} ms-2">${tool.is_active ? 'Active' : 'Inactive'}</span>
                                                <br>
                                                <small>${tool.category || 'N/A'}</small>
                                            </div>
                                            <button class="btn btn-sm btn-primary add-tool" data-agent-id="${agentId}" data-tool-id="${tool.tool_id}">Add</button>
                                        </div>
                                    `;
                                });
                                availableToolsHtml += '</div>';
                            }
                            document.getElementById('available-tools-list').innerHTML = availableToolsHtml;
                            
                            // Set up add buttons
                            document.querySelectorAll('.add-tool').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const thisAgentId = this.getAttribute('data-agent-id');
                                    const toolId = this.getAttribute('data-tool-id');
                                    
                                    fetch(`/api/agents/${thisAgentId}/tools/${toolId}`, {
                                        method: 'POST'
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        alert('Tool added to agent successfully');
                                        // Reload the modal content
                                        const modalButton = document.querySelector(`.manage-agent-tools[data-id="${thisAgentId}"]`);
                                        modalButton.click();
                                    })
                                    .catch(error => {
                                        alert('Error adding tool to agent');
                                        console.error('Error:', error);
                                    });
                                });
                            });
                        })
                        .catch(error => {
                            document.getElementById('manage-agent-info').innerHTML = 
                                `<div class="alert alert-danger">Error loading agent data</div>`;
                            console.error('Error:', error);
                        });
                });
            });
        });
    </script>
</body>
</html> 